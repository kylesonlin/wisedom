{"version":3,"file":"webpackPluginOptions.js","sources":["../../../src/config/webpackPluginOptions.ts"],"sourcesContent":["import type { SentryWebpackPluginOptions } from '@sentry/webpack-plugin';\nimport * as path from 'path';\nimport type { BuildContext, NextConfigObject, SentryBuildOptions } from './types';\n\n/**\n * Combine default and user-provided SentryWebpackPlugin options, accounting for whether we're building server files or\n * client files.\n */\nexport function getWebpackPluginOptions(\n  buildContext: BuildContext,\n  sentryBuildOptions: SentryBuildOptions,\n  releaseName: string | undefined,\n): SentryWebpackPluginOptions {\n  const { isServer, config: userNextConfig, dir, nextRuntime } = buildContext;\n\n  const prefixInsert = !isServer ? 'Client' : nextRuntime === 'edge' ? 'Edge' : 'Node.js';\n\n  // We need to convert paths to posix because Glob patterns use `\\` to escape\n  // glob characters. This clashes with Windows path separators.\n  // See: https://www.npmjs.com/package/glob\n  const projectDir = dir.replace(/\\\\/g, '/');\n  // `.next` is the default directory\n  const distDir = (userNextConfig as NextConfigObject).distDir?.replace(/\\\\/g, '/') ?? '.next';\n  const distDirAbsPath = path.posix.join(projectDir, distDir);\n\n  const sourcemapUploadAssets: string[] = [];\n  const sourcemapUploadIgnore: string[] = [];\n\n  if (isServer) {\n    sourcemapUploadAssets.push(\n      path.posix.join(distDirAbsPath, 'server', '**'), // This is normally where Next.js outputs things\n      path.posix.join(distDirAbsPath, 'serverless', '**'), // This was the output location for serverless Next.js\n    );\n  } else {\n    if (sentryBuildOptions.widenClientFileUpload) {\n      sourcemapUploadAssets.push(path.posix.join(distDirAbsPath, 'static', 'chunks', '**'));\n    } else {\n      sourcemapUploadAssets.push(\n        path.posix.join(distDirAbsPath, 'static', 'chunks', 'pages', '**'),\n        path.posix.join(distDirAbsPath, 'static', 'chunks', 'app', '**'),\n      );\n    }\n\n    // TODO: We should think about uploading these when `widenClientFileUpload` is `true`. They may be useful in some situations.\n    sourcemapUploadIgnore.push(\n      path.posix.join(distDirAbsPath, 'static', 'chunks', 'framework-*'),\n      path.posix.join(distDirAbsPath, 'static', 'chunks', 'framework.*'),\n      path.posix.join(distDirAbsPath, 'static', 'chunks', 'main-*'),\n      path.posix.join(distDirAbsPath, 'static', 'chunks', 'polyfills-*'),\n      path.posix.join(distDirAbsPath, 'static', 'chunks', 'webpack-*'),\n    );\n  }\n\n  return {\n    authToken: sentryBuildOptions.authToken,\n    headers: sentryBuildOptions.headers,\n    org: sentryBuildOptions.org,\n    project: sentryBuildOptions.project,\n    telemetry: sentryBuildOptions.telemetry,\n    debug: sentryBuildOptions.debug,\n    reactComponentAnnotation: {\n      ...sentryBuildOptions.reactComponentAnnotation,\n      ...sentryBuildOptions.unstable_sentryWebpackPluginOptions?.reactComponentAnnotation,\n    },\n    silent: sentryBuildOptions.silent,\n    url: sentryBuildOptions.sentryUrl,\n    sourcemaps: {\n      disable: sentryBuildOptions.sourcemaps?.disable,\n      rewriteSources(source) {\n        if (source.startsWith('webpack://_N_E/')) {\n          return source.replace('webpack://_N_E/', '');\n        } else if (source.startsWith('webpack://')) {\n          return source.replace('webpack://', '');\n        } else {\n          return source;\n        }\n      },\n      assets: sentryBuildOptions.sourcemaps?.assets ?? sourcemapUploadAssets,\n      ignore: sentryBuildOptions.sourcemaps?.ignore ?? sourcemapUploadIgnore,\n      filesToDeleteAfterUpload: sentryBuildOptions.sourcemaps?.deleteSourcemapsAfterUpload\n        ? [\n            // We only care to delete client bundle source maps because they would be the ones being served.\n            // Removing the server source maps crashes Vercel builds for (thus far) unknown reasons:\n            // https://github.com/getsentry/sentry-javascript/issues/13099\n            path.posix.join(distDirAbsPath, 'static', '**', '*.js.map'),\n            path.posix.join(distDirAbsPath, 'static', '**', '*.mjs.map'),\n            path.posix.join(distDirAbsPath, 'static', '**', '*.cjs.map'),\n          ]\n        : undefined,\n      ...sentryBuildOptions.unstable_sentryWebpackPluginOptions?.sourcemaps,\n    },\n    release:\n      releaseName !== undefined\n        ? {\n            inject: false, // The webpack plugin's release injection breaks the `app` directory - we inject the release manually with the value injection loader instead.\n            name: releaseName,\n            create: sentryBuildOptions.release?.create,\n            finalize: sentryBuildOptions.release?.finalize,\n            dist: sentryBuildOptions.release?.dist,\n            vcsRemote: sentryBuildOptions.release?.vcsRemote,\n            setCommits: sentryBuildOptions.release?.setCommits,\n            deploy: sentryBuildOptions.release?.deploy,\n            ...sentryBuildOptions.unstable_sentryWebpackPluginOptions?.release,\n          }\n        : {\n            inject: false,\n            create: false,\n            finalize: false,\n          },\n    bundleSizeOptimizations: {\n      ...sentryBuildOptions.bundleSizeOptimizations,\n    },\n    _metaOptions: {\n      loggerPrefixOverride: `[@sentry/nextjs - ${prefixInsert}]`,\n      telemetry: {\n        metaFramework: 'nextjs',\n      },\n    },\n    ...sentryBuildOptions.unstable_sentryWebpackPluginOptions,\n  };\n}\n"],"names":[],"mappings":"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"}